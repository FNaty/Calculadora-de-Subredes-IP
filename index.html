<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Subredes</title>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="container">
        <h1>Calculadora de Subredes IP</h1> <!-- Aqui el título y el diseño general de la calculadora -->
        <div class="card">
            <div class="form-group"> <!--Aqui la persona escribe la red base.-->
                <label for="network">Red Base (ej: 192.168.1.0/24):</label>
                <!-- aqui es el espacio para introducir la red base -->
                <input type="text" id="network" placeholder="192.168.1.0/24"> <!--en javaScript para leer el valor-->
                <div id="network-error" class="error"></div> <!--es por si pasa un error al escribir mal la red base-->
            </div>

            <div class="form-group"> <!--se pide el numero de subredes.-->
                <label for="subnets">Número de Subredes a crear:</label>
                <!-- aqui es el espacio para introducir el numero de subredes -->
                <input type="number" id="subnets" min="1" placeholder="4"> <!--javaScript lee este valor.-->
                <div id="subnets-error" class="error"></div> <!-- muestra un error si el número no es válido-->
            </div>

            <button id="calculate">Calcular Subredes</button> <!-- boton para calcular las subredes-->
        </div>
        <!-- tabla para mostrar los resultados-->
        <div id="result-container" style="display: none;"> <!--está oculto hasta que se calcule algo-->
            <h2>Resultados</h2>
            <table id="result-table">
                <thead>
                    <tr>
                        <th>Subred</th>
                        <th>Dirección de Red</th>
                        <th>Primer Host</th>
                        <th>Último Host</th>
                        <th>Broadcast</th>
                        <th>Máscara</th>
                        <th>Hosts Disponibles</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
    <script>
        document.getElementById('calculate').addEventListener('click', function () { //Cuando se hace clic se ejecuta todo
            // Limpiar mensajes de error anteriores
            document.getElementById('network-error').textContent = '';
            document.getElementById('subnets-error').textContent = '';

            // Obtener valores de entrada
            const networkInput = document.getElementById('network').value.trim();
            const subnetsInput = parseInt(document.getElementById('subnets').value);

            // Validar entrada
            let isValid = true;

            //Si la red está vacia muestra un error
            if (!networkInput) { 
                document.getElementById('network-error').textContent = 'Por favor, ingrese una dirección de red.';
                isValid = false;
            }

            // Si el número de subredes no es válido, muestra error.
            if (isNaN(subnetsInput) || subnetsInput < 1) {
                document.getElementById('subnets-error').textContent = 'Por favor, ingrese un número válido de subredes.';
                isValid = false;
            }

            if (!isValid) return;

            // Validar formato de red (debe tener formato IP/máscara)
            const networkRegex = /^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})\/(\d{1,2})$/;
            const match = networkInput.match(networkRegex);

            if (!match) {
                document.getElementById('network-error').textContent = 'Formato incorrecto. Use formato: 192.168.1.0/24';
                return;
            }

            // Validar que cada octeto esté entre 0-255
            for (let i = 1; i <= 4; i++) {
                const octet = parseInt(match[i]);
                if (octet < 0 || octet > 255) {
                    document.getElementById('network-error').textContent = 'Los octetos de la IP deben estar entre 0 y 255';
                    return;
                }
            }

            // Validar máscara (entre 1-32)
            const maskBits = parseInt(match[5]);
            if (maskBits < 1 || maskBits > 32) {
                document.getElementById('network-error').textContent = 'La máscara debe estar entre 1 y 32 bits';
                return;
            }

            // Calcular subredes
            try {
                const results = calculateSubnetsByNumber(
                    [parseInt(match[1]), parseInt(match[2]), parseInt(match[3]), parseInt(match[4])],
                    maskBits,
                    subnetsInput
                );

                // Mostrar resultados
                displayResults(results);
            } catch (error) {
                document.getElementById('network-error').textContent = error.message;
            }
        });
        //-------------------------------------------------------------------------
        function calculateSubnetsByNumber(ip, maskBits, numSubnets) {
            // 1. Calcular cuántos bits se necesitan para crear el número de subredes solicitado.
            // Por ejemplo, para 4 subredes, se necesitan 2 bits (2^2 = 4).
            const neededBits = Math.ceil(Math.log2(numSubnets));

            // 2. Calcular la nueva máscara de subred "tomando prestados" los bits.
            const newMaskBits = maskBits + neededBits;

            // Validar si hay suficientes bits disponibles en la red.
            if (newMaskBits > 32) {
                throw new Error(`No hay suficientes bits para crear ${numSubnets} subredes desde una red /${maskBits}.`);
            }

            // El número de subredes que realmente se generarán es la potencia de 2.
            // Si pides 3 subredes, se necesitan 2 bits, lo que crea 4 subredes.
            const actualNumSubnets = Math.pow(2, neededBits);

            const newMask = calculateMaskFromBits(newMaskBits);

            // 3. Calcular el número de hosts disponibles en cada nueva subred.
            const hostsPerSubnet = Math.pow(2, 32 - newMaskBits) - 2;

            // 4. Calcular el "salto" o incremento entre las direcciones de red de cada subred.
            const increment = 1 << (32 - newMaskBits);

            // 5. Convertir la IP de entrada a un número entero de 32 bits.
            const ipDecimal = (ip[0] << 24) | (ip[1] << 16) | (ip[2] << 8) | ip[3];

            // 6. Calcular la dirección de red base de la IP original para empezar desde ahí.
            const baseNetworkDecimal = ipDecimal & ((-1 << (32 - maskBits)) >>> 0);

            // 7. Generar los datos para cada subred.
            const results = [];
            for (let i = 0; i < actualNumSubnets; i++) {
                const subnetDecimal = baseNetworkDecimal + (i * increment);
                const networkAddress = decimalToIp(subnetDecimal);
                const broadcastAddress = decimalToIp(subnetDecimal + increment - 1);
                const firstHost = decimalToIp(subnetDecimal + 1);
                const lastHost = decimalToIp(subnetDecimal + increment - 2); // -2 porque -1 es broadcast

                results.push({
                    subnet: i + 1,
                    network: networkAddress,
                    firstHost: (hostsPerSubnet > 0) ? firstHost : 'N/A',
                    lastHost: (hostsPerSubnet > 0) ? lastHost : 'N/A',
                    broadcast: broadcastAddress, 
                    mask: newMask.join('.'),
                    hosts: hostsPerSubnet
                });
            }

            return results;
        }

        // Genera la mascara de subred en formato decimal
        function calculateMaskFromBits(bits) {
            let mask = 0;
            for (let i = 0; i < bits; i++) {
                mask |= (1 << (31 - i));
            }

            return [
                (mask >> 24) & 255,
                (mask >> 16) & 255,
                (mask >> 8) & 255,
                mask & 255
            ];
        }

        //Convierte un número decimal de 32 bits a formato IP
        function decimalToIp(decimal) {
            return [
                (decimal >> 24) & 255,
                (decimal >> 16) & 255,
                (decimal >> 8) & 255,
                decimal & 255
            ].join('.');
        }

        //Crea las filas de la tabla y muestra todos los cálculos de subredes
        function displayResults(results) {
            const tbody = document.querySelector('#result-table tbody');
            tbody.innerHTML = '';

            results.forEach(result => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.subnet}</td>
                    <td>${result.network}</td>
                    <td>${result.firstHost}</td>
                    <td>${result.lastHost}</td>
                    <td>${result.broadcast}</td>
                    <td>${result.mask}</td>
                    <td>${result.hosts}</td>
                `;
                tbody.appendChild(row);
            });

            document.getElementById('result-container').style.display = 'block';
        }
    </script>
</body>

</html>